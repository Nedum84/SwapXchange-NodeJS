service: swapxchange-service
frameworkVersion: "2"

provider:
  name: aws
  runtime: nodejs14.x
  memorySize: 128
  timeout: 10
  tags:
    service: swapxchange
  lambdaHashingVersion: "20201221"
  region: eu-west-2
  iam:
    role: arn:aws:iam::899172222060:role/XchangeRole
#    role: arn:aws:iam::899172222060:role/aws-service-role/ops.apigateway.amazonaws.com/AWSServiceRoleForAPIGateway
  environment:
    NODE_OPTIONS: --enable-source-maps
  vpc:
    securityGroupIds:
      - sg-0e16ecd2de3007de4 #Private
    subnetIds:
      - subnet-06ac3f82667ebe9f0
      - subnet-0f979ac6191ee988b
      - subnet-047d66d6a250068ae

#package:
#  patterns:
#    - 'src/database/**'
#    - '.env'
#    - '!node_modules/**' #Exclude all node_modules sub dirs

package:
  patterns:
    - '!src/**'
    - 'build/src/**'
    - 'build/src/database/**'
    - '.env'
#    - '!node_modules/**' #Exclude all node_modules sub dirs

plugins:
  - serverless-plugin-typescript
  - serverless-offline
  - serverless-plugin-scripts


custom:
  scripts:
    hooks:
#      'after:deploy:finalize': npm run db:migrate
#      'aws:deploy:finalize:cleanup': npm run db:migrate

functions:
  databaseMigrations:
    handler: src/aws/lambda-migrate.handler
    timeout: 300 # 5 minutes
    memorySize: 512
  cli:
    handler: src/aws/lambda-cli.handler
    timeout: 300 # 5 minutes
  api:
    handler: src/aws/lambda.handler
    timeout: 30
    memorySize: 512
    events:
      - http:
          path: /api/v1
          method: ANY
          cors: true
      - http:
          path: /api/v1/{proxy+}
          method: ANY
          cors: true

